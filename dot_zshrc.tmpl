# === STARSHIP AUTOMATIC INSTALLATION ===
# Ensures Starship is present in every environment (Mac, Linux, DevPod)
if ! command -v starship &> /dev/null; then
    echo "üöÄ Starship not found. Installing..."
    if [[ "$OSTYPE" == "darwin"* ]]; then
        brew install starship &> /dev/null || curl -sS https://starship.rs/install.sh | sh -s -- -y
    else
        # For Linux/DevPod - installs to /usr/local/bin by default
        curl -sS https://starship.rs/install.sh | sh -s -- -y
    fi
fi

# Init Starship prompt
eval "$(starship init zsh)"

# === UNIVERSAL SETTINGS ===
alias ll="ls -la"
alias ..="cd .."
alias lg="lazygit"
alias lz="lazygit"
alias lzd="lazydocker"

# === DEVPOD GALUTINƒñ FUNKCIJA ===
devon() {
    mkdir -p .devcontainer
    # Naudojame 'EOF', kad kintamieji neb≈´t≈≥ interpretuojami Mac'o shell'e
    cat <<'INNEREOF' > .devcontainer/devcontainer.json
{
    "name": "Ultimate DevSecOps Environment",
    "image": "mcr.microsoft.com/devcontainers/universal:latest",
    "features": {
        "ghcr.io/devcontainers/features/common-utils:1": {
            "configureZshAsDefaultShell": true
        },
        "ghcr.io/devcontainers/features/docker-in-docker:2": {
            "moby": false
        },
        "ghcr.io/devcontainers/features/terraform:1": {},
        "ghcr.io/devcontainers/features/kubectl-helm-minikube:1": {},
        "ghcr.io/devcontainers/features/aws-cli:1": {},
        "ghcr.io/devcontainers/features/azure-cli:1": {}
    },
    "customizations": {
        "vscode": {
            "settings": {
                "terminal.integrated.fontFamily": "JetBrainsMono Nerd Font"
            },
            "extensions": [
                "ms-azuretools.vscode-docker",
                "ms-kubernetes-tools.vscode-kubernetes-tools",
                "hashicorp.terraform",
                "redhat.ansible",
                "amazonwebservices.aws-toolkit-vscode",
                "ms-vscode.azurecli",
                "snyk-security.snyk-vscode",
                "knqyf263.trivy-vulnerability-scanner",
                "asvetliakov.vscode-neovim"
            ]
        }
    },
    "postCreateCommand": "sudo apt-get update && sudo apt-get install -y libgtk2.0-0 libgtk-3-0 libgbm-dev libnotify-dev libnss3 libxss1 libasound2t64 libxtst6 xauth xvfb && curl -LO https://github.com/neovim/neovim/releases/download/nightly/nvim-linux-x86_64.tar.gz && sudo rm -rf /opt/nvim && sudo tar -C /opt -xzf nvim-linux-x86_64.tar.gz && sudo ln -sf /opt/nvim-linux-x86_64/bin/nvim /usr/local/bin/nvim && sudo npm install -g snyk && curl -sS https://webinstall.dev/k9s | bash && curl -sfL https://raw.githubusercontent.com/jesseduffield/lazygit/master/scripts/install_update_linux.sh | sudo bash && curl -sfL https://raw.githubusercontent.com/jesseduffield/lazydocker/master/scripts/install_update_linux.sh | sudo bash && curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sudo sh -s -- -b /usr/local/bin && sudo curl -sL https://dl.min.io/client/mc/release/linux-amd64/mc -o /usr/local/bin/mc && sudo chmod +x /usr/local/bin/mc && ( [ ! -d ~/.config/nvim ] && git clone https://github.com/LazyVim/starter ~/.config/nvim || true ) && sh -c \"$(curl -fsLS get.chezmoi.io)\" -- init --apply estanionis/.dotfiles"
}
INNEREOF
    echo "‚úÖ DevSecOps paruo≈°tas (su pataisytu JSON)"
}

devoff() {
    rm -rf .devcontainer
    echo "üóëÔ∏è  Local .devcontainer removed"
}

# Updated dclean to be robust: doesn't fail if workspace is already gone
dclean() {
    devoff
    local ws_name=$(basename "$PWD")
    echo "‚è≥ Deleting DevPod workspace: $ws_name..."
    devpod delete "$ws_name" --force || echo "‚ö†Ô∏è  Workspace '$ws_name' not found or already deleted. Continuing."
}

# === GIT CONFIGURATION ===
# Automatically sets the global ignore file
git config --global core.excludesfile ~/.gitignore_global

# Manual alias to resync git global ignore settings
alias gsync="git config --global core.excludesfile ~/.gitignore_global && echo '‚úÖ Git global ignore synced'"

# Pushes all chezmoi changes to GitHub with one command
alias dpush="cd \$(chezmoi source-path) && git add . && git commit -m 'update' && git push && cd -"

# === DEVPOD TERMINAL COMMANDS ===
# Quickly spin up the current folder in DevPod using your SSH provider
alias dup="devpod up . --provider ssh"
alias dls="devpod list"
alias dstop="devpod stop"
# Renamed from dclean to dprune to avoid conflict with dclean function
alias dprune="devpod list | grep 'Exited' | awk '{print \$1}' | xargs -r devpod delete"

# Combined command: prepares environment AND starts DevPod
devup() {
    devon
    devpod up . --provider ssh
}

# === MAC SPECIFIC SETTINGS ===
{{- if eq .chezmoi.os "darwin" }}
# Antigravity & AI settings
export PATH="/Users/user/.antigravity/antigravity/bin:$PATH"
export PATH="/path/to/gemini-cli:$PATH"

# Google Cloud SDK
if [ -f '/Users/user/Downloads/google-cloud-sdk/path.zsh.inc' ]; then . '/Users/user/Downloads/google-cloud-sdk/path.zsh.inc'; fi
if [ -f '/Users/user/Downloads/google-cloud-sdk/completion.zsh.inc' ]; then . '/Users/user/Downloads/google-cloud-sdk/completion.zsh.inc'; fi
{{- end }}

# === LINUX / DEVPOD SPECIFIC SETTINGS ===
{{- if eq .chezmoi.os "linux" }}
# Add specific Linux server tweaks here
{{- end }}
